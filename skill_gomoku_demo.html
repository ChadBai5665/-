<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>æŠ€èƒ½äº”å­æ£‹ Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
        }
        #board {
            display: grid;
            margin: 20px auto;
            grid-gap: 0;
        }
        .cell {
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            background-color: #fff;
        }
        #skills {
            margin: 10px auto;
            max-width: 800px;
        }
        button {
            margin: 4px;
            padding: 6px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #efefef;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        .icon {
            margin-right: 4px;
        }
        pre {
            text-align: left;
            display: inline-block;
            max-width: 90%;
            overflow-x: auto;
            background: #f8f8f8;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .cold-palace {
            background-color: #f9e2e2;
        }
        .skills-group {
            margin-bottom: 10px;
        }

        /* Board container centers the board horizontally */
        #board-container {
            display: flex;
            justify-content: center;
            margin: 20px auto;
        }
        /* Skill description section formatting */
        #skillDescriptions {
            max-width: 800px;
            margin: 10px auto;
            text-align: left;
        }
        #skillDescriptions p {
            margin: 4px 0;
            line-height: 1.4;
        }

        /* Footer section styling */
        #footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        #footer img {
            margin-top: 10px;
            width: 150px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>æŠ€èƒ½äº”å­æ£‹ Demo</h1>
    <p id="status"></p>
    <div id="skills">
        <div class="skills-group" id="é»‘æ‰‹Skills">
            <strong>é»‘æ‰‹æŠ€èƒ½ï¼š</strong>
            <button id="é£æ²™èµ°çŸ³é»‘æ‰‹" title="ç§»é™¤å¯¹æ‰‹ä»»æ„ä¸€æšæ£‹å­ï¼Œå¹¶å°é”è¯¥è½ç‚¹ä½¿å…¶ä¸‹ä¸€å›åˆæ— æ³•è½å­ã€‚"><span class="icon">ğŸ’¨</span>é£æ²™èµ°çŸ³</button>
            <button id="åŠ›æ‹”å±±å…®é»‘æ‰‹" title="æ€ç¿»æ£‹ç›˜ï¼Œæ£‹ç›˜ä¸Šå½“å‰çš„æ£‹å­éšæœºæ‰è½ã€‚"><span class="icon">ğŸ”ï¸</span>åŠ›æ‹”å±±å…®</button>
            <button id="é™å¦‚æ­¢æ°´é»‘æ‰‹" title="å†»ç»“æ—¶é—´ï¼Œä½¿å¯¹æ‰‹å¤±å»ä¸€å›åˆè½å­æœºä¼šã€‚"><span class="icon">â„ï¸</span>é™å¦‚æ­¢æ°´</button>
            <button id="è°ƒå‘ˆç¦»å±±é»‘æ‰‹" title="å¼ºåˆ¶å°†å¯¹æ‰‹æ£‹å­ç§»åŠ¨åˆ°æ£‹ç›˜è¾¹ç¼˜çš„å†·å®«åŒºï¼Œè¯¥åŒºåŸŸæ£‹å­æ— æ³•å‚ä¸è¿ç ã€‚"><span class="icon">â†ªï¸</span>è°ƒå‘ˆç¦»å±±</button>
            <button id="æ—¶å…‰å€’æµé»‘æ‰‹" title="å°†æ£‹å±€é‡ç½®å›3æ­¥ä¹‹å‰çš„çŠ¶æ€ï¼ŒåŒæ–¹æ£‹å­ä½ç½®æ¢å¤ã€‚"><span class="icon">âª</span>æ—¶å…‰å€’æµ</button>
            <button id="æ‹¾é‡‘ä¸æ˜§é»‘æ‰‹" title="éšæœºä¸å¯¹æ‰‹äº¤æ¢ä¸€æšæ£‹å­ï¼ŒåŒ…æ‹¬å·²è¿æˆçº¿çš„æ£‹å­ã€‚"><span class="icon">ğŸ”„</span>æ‹¾é‡‘ä¸æ˜§</button>
        </div>
        <div class="skills-group" id="ç™½æ‰‹Skills">
            <strong>ç™½æ‰‹æŠ€èƒ½ï¼š</strong>
            <button id="é£æ²™èµ°çŸ³ç™½æ‰‹" title="ç§»é™¤å¯¹æ‰‹ä»»æ„ä¸€æšæ£‹å­ï¼Œå¹¶å°é”è¯¥è½ç‚¹ä½¿å…¶ä¸‹ä¸€å›åˆæ— æ³•è½å­ã€‚"><span class="icon">ğŸ’¨</span>é£æ²™èµ°çŸ³</button>
            <button id="åŠ›æ‹”å±±å…®ç™½æ‰‹" title="æ€ç¿»æ£‹ç›˜ï¼Œæ£‹ç›˜ä¸Šå½“å‰çš„æ£‹å­éšæœºæ‰è½ã€‚"><span class="icon">ğŸ”ï¸</span>åŠ›æ‹”å±±å…®</button>
            <button id="é™å¦‚æ­¢æ°´ç™½æ‰‹" title="å†»ç»“æ—¶é—´ï¼Œä½¿å¯¹æ‰‹å¤±å»ä¸€å›åˆè½å­æœºä¼šã€‚"><span class="icon">â„ï¸</span>é™å¦‚æ­¢æ°´</button>
            <button id="è°ƒå‘ˆç¦»å±±ç™½æ‰‹" title="å¼ºåˆ¶å°†å¯¹æ‰‹æ£‹å­ç§»åŠ¨åˆ°æ£‹ç›˜è¾¹ç¼˜çš„å†·å®«åŒºï¼Œè¯¥åŒºåŸŸæ£‹å­æ— æ³•å‚ä¸è¿ç ã€‚"><span class="icon">â†ªï¸</span>è°ƒå‘ˆç¦»å±±</button>
            <button id="æ—¶å…‰å€’æµç™½æ‰‹" title="å°†æ£‹å±€é‡ç½®å›3æ­¥ä¹‹å‰çš„çŠ¶æ€ï¼ŒåŒæ–¹æ£‹å­ä½ç½®æ¢å¤ã€‚"><span class="icon">âª</span>æ—¶å…‰å€’æµ</button>
            <button id="æ‹¾é‡‘ä¸æ˜§ç™½æ‰‹" title="éšæœºä¸å¯¹æ‰‹äº¤æ¢ä¸€æšæ£‹å­ï¼ŒåŒ…æ‹¬å·²è¿æˆçº¿çš„æ£‹å­ã€‚"><span class="icon">ğŸ”„</span>æ‹¾é‡‘ä¸æ˜§</button>
        </div>
        <button id="restart">é‡æ–°å¼€å§‹</button>
    </div>
    <!-- ä¸­å¤®æ£‹ç›˜åŒºåŸŸ -->
    <div id="board-container">
        <div id="board"></div>
    </div>
    <!-- æŠ€èƒ½æè¿°æ–‡å­—ç‰ˆ -->
    <h3>æŠ€èƒ½æè¿°</h3>
    <div id="skillDescriptions">
        <p><strong>é£æ²™èµ°çŸ³ï¼š</strong>ç§»é™¤å¯¹æ‰‹ä»»æ„ä¸€æšæ£‹å­ï¼Œå¹¶å°é”è¯¥è½ç‚¹ä½¿å…¶ä¸‹ä¸€å›åˆæ— æ³•è½å­ã€‚</p>
        <p><strong>åŠ›æ‹”å±±å…®ï¼š</strong>æ€ç¿»æ£‹ç›˜ï¼Œæ£‹ç›˜ä¸Šå½“å‰çš„æ£‹å­éšæœºæ‰è½ä¸€åŠã€‚</p>
        <p><strong>é™å¦‚æ­¢æ°´ï¼š</strong>å†»ç»“æ—¶é—´ï¼Œä½¿å¯¹æ‰‹å¤±å»ä¸€å›åˆè½å­æœºä¼šã€‚</p>
        <p><strong>è°ƒå‘ˆç¦»å±±ï¼š</strong>å¼ºåˆ¶å°†å¯¹æ‰‹æ£‹å­ç§»åŠ¨åˆ°æ£‹ç›˜è¾¹ç¼˜çš„å†·å®«åŒºï¼Œè¯¥æ£‹å­æ— æ³•å‚ä¸è¿ç ã€‚</p>
        <p><strong>æ—¶å…‰å€’æµï¼š</strong>å°†æ£‹å±€é‡ç½®å› 3 æ­¥ä¹‹å‰çš„çŠ¶æ€ï¼ŒåŒæ–¹æ£‹å­ä½ç½®æ¢å¤ã€‚</p>
        <p><strong>æ‹¾é‡‘ä¸æ˜§ï¼š</strong>éšæœºä¸å¯¹æ‰‹äº¤æ¢ä¸€æšæ£‹å­ï¼ŒåŒ…æ‹¬å·²è¿æˆçº¿çš„æ£‹å­ã€‚</p>
    </div>

    <!-- åº•éƒ¨ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬å·ã€åˆ¶ä½œè€…å’Œå…¬ä¼—å·äºŒç»´ç  -->
    <div id="footer">
        <p>ç‰ˆæœ¬ï¼šV 5.2</p>
        <p>åˆ›ä½œè€…ï¼šChadBai</p>
        <p>å…¬ä¼—å·ï¼šå°å°‘çš„AIé“¾è·¯ç¬”è®°</p>
        <img src="qrcode.png" alt="å…¬ä¼—å·äºŒç»´ç ">
    </div>
    <script>
        const boardSize = 11;
        let board = [];
        let currentPlayer = 1;
        let moves = [];
        let skillActive = {1: null, 2: null};
        let skillUsed = {
            1: {'é£æ²™èµ°çŸ³': false, 'åŠ›æ‹”å±±å…®': false, 'é™å¦‚æ­¢æ°´': false, 'è°ƒå‘ˆç¦»å±±': false, 'æ—¶å…‰å€’æµ': false, 'æ‹¾é‡‘ä¸æ˜§': false},
            2: {'é£æ²™èµ°çŸ³': false, 'åŠ›æ‹”å±±å…®': false, 'é™å¦‚æ­¢æ°´': false, 'è°ƒå‘ˆç¦»å±±': false, 'æ—¶å…‰å€’æµ': false, 'æ‹¾é‡‘ä¸æ˜§': false}
        };
        let blockedPositions = {}; // position key -> player id blocked
        let skipNextTurn = {1: false, 2: false};
        let coldPalacePositions = {}; // key -> true for cold palace
        const playerNames = {1: 'é»‘æ‰‹', 2: 'ç™½æ‰‹'};
        const skillDescriptions = {
            'é£æ²™èµ°çŸ³': 'ç§»é™¤å¯¹æ‰‹ä»»æ„ä¸€æšæ£‹å­ï¼Œå¹¶å°é”è¯¥è½ç‚¹ä½¿å…¶ä¸‹ä¸€å›åˆæ— æ³•è½å­ã€‚',
            'åŠ›æ‹”å±±å…®': 'æ€ç¿»æ£‹ç›˜ï¼Œæ£‹ç›˜ä¸Šå½“å‰çš„æ£‹å­éšæœºæ‰è½ä¸€åŠã€‚',
            'é™å¦‚æ­¢æ°´': 'å†»ç»“æ—¶é—´ï¼Œä½¿å¯¹æ‰‹å¤±å»ä¸€å›åˆè½å­æœºä¼šã€‚',
            'è°ƒå‘ˆç¦»å±±': 'å¼ºåˆ¶å°†å¯¹æ‰‹æ£‹å­ç§»åŠ¨åˆ°æ£‹ç›˜è¾¹ç¼˜çš„å†·å®«åŒºï¼Œè¯¥åŒºåŸŸæ£‹å­æ— æ³•å‚ä¸è¿ç ã€‚',
            'æ—¶å…‰å€’æµ': 'å°†æ£‹å±€é‡ç½®å›3æ­¥ä¹‹å‰çš„çŠ¶æ€ï¼ŒåŒæ–¹æ£‹å­ä½ç½®æ¢å¤ã€‚',
            'æ‹¾é‡‘ä¸æ˜§': 'éšæœºä¸å¯¹æ‰‹äº¤æ¢ä¸€æšæ£‹å­ï¼ŒåŒ…æ‹¬å·²è¿æˆçº¿çš„æ£‹å­ã€‚'
        };
        const nextStep = {
            'é£æ²™èµ°çŸ³': 'è¯·é€‰æ‹©è¦ç§»é™¤çš„å¯¹æ‰‹æ£‹å­ã€‚',
            'åŠ›æ‹”å±±å…®': 'è¯·ç‚¹å‡»æ£‹ç›˜ä»»æ„ä½ç½®å‘åŠ¨æŠ€èƒ½ï¼Œæ£‹å­å°†éšæœºæ‰è½ã€‚',
            'é™å¦‚æ­¢æ°´': 'è¯·ç‚¹å‡»æ£‹ç›˜ä»»æ„ä½ç½®å‘åŠ¨æŠ€èƒ½ï¼Œå†»ç»“å¯¹æ‰‹çš„ä¸‹ä¸€å›åˆã€‚',
            'è°ƒå‘ˆç¦»å±±': 'è¯·é€‰æ‹©è¦ç§»åŠ¨åˆ°å†·å®«åŒºçš„å¯¹æ‰‹æ£‹å­ã€‚',
            'æ—¶å…‰å€’æµ': 'è¯·ç‚¹å‡»æ£‹ç›˜ä»»æ„ä½ç½®å›é€€åˆ°3æ­¥ä¹‹å‰ã€‚',
            'æ‹¾é‡‘ä¸æ˜§': 'è¯·ç‚¹å‡»æ£‹ç›˜ä»»æ„ä½ç½®éšæœºäº¤æ¢ä¸€æšæ£‹å­ã€‚'
        };

        function initBoard() {
            board = [];
            for (let r = 0; r < boardSize; r++) {
                const row = [];
                for (let c = 0; c < boardSize; c++) {
                    row.push(0);
                }
                board.push(row);
            }
        }

        function restartGame() {
            initBoard();
            moves = [];
            blockedPositions = {};
            skipNextTurn = {1: false, 2: false};
            coldPalacePositions = {};
            currentPlayer = 1;
            skillActive = {1: null, 2: null};
            skillUsed = {
                1: {'é£æ²™èµ°çŸ³': false, 'åŠ›æ‹”å±±å…®': false, 'é™å¦‚æ­¢æ°´': false, 'è°ƒå‘ˆç¦»å±±': false, 'æ—¶å…‰å€’æµ': false, 'æ‹¾é‡‘ä¸æ˜§': false},
                2: {'é£æ²™èµ°çŸ³': false, 'åŠ›æ‹”å±±å…®': false, 'é™å¦‚æ­¢æ°´': false, 'è°ƒå‘ˆç¦»å±±': false, 'æ—¶å…‰å€’æµ': false, 'æ‹¾é‡‘ä¸æ˜§': false}
            };
            renderBoard();
            updateSkillButtons();
            document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
        }

        function renderBoard() {
            const container = document.getElementById('board');
            container.style.gridTemplateColumns = `repeat(${boardSize}, 32px)`;
            container.innerHTML = '';
            for (let r = 0; r < boardSize; r++) {
                for (let c = 0; c < boardSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const key = `${r},${c}`;
                    if (coldPalacePositions[key]) {
                        cell.classList.add('cold-palace');
                    }
                    if (board[r][c] === 1) {
                        cell.textContent = 'â—';
                    } else if (board[r][c] === 2) {
                        cell.textContent = 'â—‹';
                    }
                    cell.addEventListener('click', () => handleClick(r, c));
                    container.appendChild(cell);
                }
            }
        }

        function disableBoard() {
            const oldBoard = document.getElementById('board');
            const newBoard = oldBoard.cloneNode(true);
            oldBoard.parentNode.replaceChild(newBoard, oldBoard);
        }

        function disableAllSkills() {
            const skillNames = ['é£æ²™èµ°çŸ³','åŠ›æ‹”å±±å…®','é™å¦‚æ­¢æ°´','è°ƒå‘ˆç¦»å±±','æ—¶å…‰å€’æµ','æ‹¾é‡‘ä¸æ˜§'];
            for (const name of skillNames) {
                document.getElementById(name + 'é»‘æ‰‹').disabled = true;
                document.getElementById(name + 'ç™½æ‰‹').disabled = true;
            }
        }

        function setSkill(player, skill) {
            if (skillUsed[player][skill]) return;
            skillActive[player] = skill;
            updateSkillButtons();
            document.getElementById('status').textContent = playerNames[player] + 'é€‰æ‹©äº†æŠ€èƒ½ ' + skill + 'ï¼š' + skillDescriptions[skill] + ' ' + nextStep[skill];
        }

        function updateSkillButtons() {
            const skills = ['é£æ²™èµ°çŸ³','åŠ›æ‹”å±±å…®','é™å¦‚æ­¢æ°´','è°ƒå‘ˆç¦»å±±','æ—¶å…‰å€’æµ','æ‹¾é‡‘ä¸æ˜§'];
            // é»‘æ‰‹
            for (const name of skills) {
                const btn1 = document.getElementById(name + 'é»‘æ‰‹');
                // ç¦ç”¨æ¡ä»¶ï¼šæŠ€èƒ½å·²ç”¨è¿‡ã€å·²æœ‰æŠ€èƒ½å¾…æ‰§è¡Œï¼Œæˆ–å½“å‰ä¸æ˜¯é»‘æ‰‹å›åˆ
                btn1.disabled = skillUsed[1][name] || (skillActive[1] !== null) || (currentPlayer !== 1);
            }
            // ç™½æ‰‹
            for (const name of skills) {
                const btn2 = document.getElementById(name + 'ç™½æ‰‹');
                // ç¦ç”¨æ¡ä»¶ï¼šæŠ€èƒ½å·²ç”¨è¿‡ã€å·²æœ‰æŠ€èƒ½å¾…æ‰§è¡Œï¼Œæˆ–å½“å‰ä¸æ˜¯ç™½æ‰‹å›åˆ
                btn2.disabled = skillUsed[2][name] || (skillActive[2] !== null) || (currentPlayer !== 2);
            }
        }

        function handleClick(row, col) {
            // Skip next turn if applicable
            if (skipNextTurn[currentPlayer]) {
                skipNextTurn[currentPlayer] = false;
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                // æ›´æ–°æŠ€èƒ½æŒ‰é’®ä»¥åæ˜ æ–°å›åˆ
                updateSkillButtons();
                document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
                return;
            }
            // Remove blocked positions for current player at start of their turn
            for (const key in blockedPositions) {
                if (blockedPositions[key] === currentPlayer) {
                    delete blockedPositions[key];
                }
            }
            const skill = skillActive[currentPlayer];
            const opponent = currentPlayer === 1 ? 2 : 1;
            // Handle skill usage if active
            if (skill) {
                if (skill === 'é£æ²™èµ°çŸ³') {
                    // Only allow removing opponent's stone
                    if (board[row][col] === opponent) {
                        blockedPositions[`${row},${col}`] = opponent;
                        board[row][col] = 0;
                        delete coldPalacePositions[`${row},${col}`];
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['é£æ²™èµ°çŸ³'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    // æ›´æ–°æŠ€èƒ½æŒ‰é’®ä»¥åæ˜ å›åˆåˆ‡æ¢
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
                    return;
                } else if (skill === 'åŠ›æ‹”å±±å…®') {
                    // Randomly remove pieces from the board (50% chance)
                    for (let r = 0; r < boardSize; r++) {
                        for (let c = 0; c < boardSize; c++) {
                            if (board[r][c] !== 0) {
                                if (Math.random() < 0.5) {
                                    board[r][c] = 0;
                                    delete coldPalacePositions[`${r},${c}`];
                                }
                            }
                        }
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['åŠ›æ‹”å±±å…®'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
                    return;
                } else if (skill === 'é™å¦‚æ­¢æ°´') {
                    // Freeze opponent: skip their next turn
                    skipNextTurn[opponent] = true;
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['é™å¦‚æ­¢æ°´'] = true;
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
                    return;
                } else if (skill === 'è°ƒå‘ˆç¦»å±±') {
                    // Move opponent's stone to edge cold palace
                    if (board[row][col] === opponent) {
                        const edges = [];
                        for (let r = 0; r < boardSize; r++) {
                            for (let c = 0; c < boardSize; c++) {
                                if (r === 0 || c === 0 || r === boardSize - 1 || c === boardSize - 1) {
                                    if (board[r][c] === 0) {
                                        edges.push({r: r, c: c});
                                    }
                                }
                            }
                        }
                        if (edges.length > 0) {
                            const idx = Math.floor(Math.random() * edges.length);
                            const newPos = edges[idx];
                            board[row][col] = 0;
                            delete coldPalacePositions[`${row},${col}`];
                            board[newPos.r][newPos.c] = opponent;
                            coldPalacePositions[`${newPos.r},${newPos.c}`] = true;
                        }
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['è°ƒå‘ˆç¦»å±±'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
                    return;
                } else if (skill === 'æ—¶å…‰å€’æµ') {
                    const skillUser = currentPlayer;
                    let removed = 0;
                    while (moves.length > 0 && removed < 3) {
                        const lastMove = moves.pop();
                        board[lastMove.row][lastMove.col] = 0;
                        delete coldPalacePositions[`${lastMove.row},${lastMove.col}`];
                        removed++;
                    }
                    if (moves.length === 0) {
                        currentPlayer = 1;
                    } else {
                        const lastMove = moves[moves.length - 1];
                        currentPlayer = lastMove.player === 1 ? 2 : 1;
                    }
                    skillActive[skillUser] = null;
                    skillUsed[skillUser]['æ—¶å…‰å€’æµ'] = true;
                    updateSkillButtons();
                    renderBoard();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
                    return;
                } else if (skill === 'æ‹¾é‡‘ä¸æ˜§') {
                    const currentPieces = [];
                    const opponentPieces = [];
                    for (let r = 0; r < boardSize; r++) {
                        for (let c = 0; c < boardSize; c++) {
                            if (board[r][c] === currentPlayer) currentPieces.push({r: r, c: c});
                            else if (board[r][c] === opponent) opponentPieces.push({r: r, c: c});
                        }
                    }
                    if (currentPieces.length > 0 && opponentPieces.length > 0) {
                        const cp = currentPieces[Math.floor(Math.random() * currentPieces.length)];
                        const op = opponentPieces[Math.floor(Math.random() * opponentPieces.length)];
                        const cpCold = coldPalacePositions[`${cp.r},${cp.c}`] ? true : false;
                        const opCold = coldPalacePositions[`${op.r},${op.c}`] ? true : false;
                        board[cp.r][cp.c] = opponent;
                        board[op.r][op.c] = currentPlayer;
                        delete coldPalacePositions[`${cp.r},${cp.c}`];
                        delete coldPalacePositions[`${op.r},${op.c}`];
                        if (cpCold) {
                            coldPalacePositions[`${op.r},${op.c}`] = true;
                        }
                        if (opCold) {
                            coldPalacePositions[`${cp.r},${cp.c}`] = true;
                        }
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['æ‹¾é‡‘ä¸æ˜§'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
                    return;
                }
            }
            // No skill active: place a piece
            const key = `${row},${col}`;
            if (board[row][col] !== 0) return;
            if (blockedPositions[key] === currentPlayer) return;
            board[row][col] = currentPlayer;
            moves.push({row: row, col: col, player: currentPlayer});
            renderBoard();
            if (checkWin(currentPlayer, row, col)) {
                document.getElementById('status').textContent = playerNames[currentPlayer] + 'èƒœåˆ©ï¼';
                disableBoard();
                disableAllSkills();
                return;
            }
            currentPlayer = opponent;
            updateSkillButtons();
            document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
        }

        function checkWin(player, row, col) {
            function count(dirRow, dirCol) {
                let count = 0;
                let r = row + dirRow;
                let c = col + dirCol;
                while (r >= 0 && r < boardSize && c >= 0 && c < boardSize && board[r][c] === player && !coldPalacePositions[`${r},${c}`]) {
                    count++;
                    r += dirRow;
                    c += dirCol;
                }
                return count;
            }
            const directions = [[0,1],[1,0],[1,1],[1,-1]];
            for (const [dr, dc] of directions) {
                let total = 1 + count(dr, dc) + count(-dr, -dc);
                if (total >= 5) return true;
            }
            return false;
        }

        function init() {
            initBoard();
            renderBoard();
            document.getElementById('status').textContent = playerNames[currentPlayer] + 'è½å­';
            const skills = ['é£æ²™èµ°çŸ³','åŠ›æ‹”å±±å…®','é™å¦‚æ­¢æ°´','è°ƒå‘ˆç¦»å±±','æ—¶å…‰å€’æµ','æ‹¾é‡‘ä¸æ˜§'];
            for (const name of skills) {
                document.getElementById(name + 'é»‘æ‰‹').addEventListener('click', () => setSkill(1, name));
                document.getElementById(name + 'ç™½æ‰‹').addEventListener('click', () => setSkill(2, name));
            }
            document.getElementById('restart').addEventListener('click', restartGame);
            updateSkillButtons();
            // ä¸å†ç”ŸæˆæŠ€èƒ½å®šä¹‰çš„ JSON æ–‡æœ¬ï¼ŒæŠ€èƒ½æè¿°å·²åœ¨é¡µé¢ä¸Šä»¥æ–‡å­—å±•ç¤º
        }
        window.onload = init;
    </script>
</body>
</html>
