<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>技能五子棋 Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #f9f9f9;
        }
        #board {
            display: grid;
            margin: 20px auto;
            grid-gap: 0;
        }
        .cell {
            width: 32px;
            height: 32px;
            border: 1px solid #ccc;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            user-select: none;
            background-color: #fff;
        }
        #skills {
            margin: 10px auto;
            max-width: 800px;
        }
        button {
            margin: 4px;
            padding: 6px 10px;
            font-size: 14px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #efefef;
            cursor: pointer;
        }
        button:disabled {
            background-color: #ddd;
            cursor: not-allowed;
        }
        .icon {
            margin-right: 4px;
        }
        pre {
            text-align: left;
            display: inline-block;
            max-width: 90%;
            overflow-x: auto;
            background: #f8f8f8;
            padding: 10px;
            border: 1px solid #ccc;
        }
        .cold-palace {
            background-color: #f9e2e2;
        }
        .skills-group {
            margin-bottom: 10px;
        }

        /* Board container centers the board horizontally */
        #board-container {
            display: flex;
            justify-content: center;
            margin: 20px auto;
        }
        /* Skill description section formatting */
        #skillDescriptions {
            max-width: 800px;
            margin: 10px auto;
            text-align: left;
        }
        #skillDescriptions p {
            margin: 4px 0;
            line-height: 1.4;
        }

        /* Footer section styling */
        #footer {
            margin-top: 20px;
            font-size: 12px;
            color: #666;
            text-align: center;
        }
        #footer img {
            margin-top: 10px;
            width: 150px;
            height: auto;
        }
    </style>
</head>
<body>
    <h1>技能五子棋 Demo</h1>
    <p id="status"></p>
    <div id="skills">
        <div class="skills-group" id="黑手Skills">
            <strong>黑手技能：</strong>
            <button id="飞沙走石黑手" title="移除对手任意一枚棋子，并封锁该落点使其下一回合无法落子。"><span class="icon">💨</span>飞沙走石</button>
            <button id="力拔山兮黑手" title="掀翻棋盘，棋盘上当前的棋子随机掉落。"><span class="icon">🏔️</span>力拔山兮</button>
            <button id="静如止水黑手" title="冻结时间，使对手失去一回合落子机会。"><span class="icon">❄️</span>静如止水</button>
            <button id="调呈离山黑手" title="强制将对手棋子移动到棋盘边缘的冷宫区，该区域棋子无法参与连珠。"><span class="icon">↪️</span>调呈离山</button>
            <button id="时光倒流黑手" title="将棋局重置回3步之前的状态，双方棋子位置恢复。"><span class="icon">⏪</span>时光倒流</button>
            <button id="拾金不昧黑手" title="随机与对手交换一枚棋子，包括已连成线的棋子。"><span class="icon">🔄</span>拾金不昧</button>
        </div>
        <div class="skills-group" id="白手Skills">
            <strong>白手技能：</strong>
            <button id="飞沙走石白手" title="移除对手任意一枚棋子，并封锁该落点使其下一回合无法落子。"><span class="icon">💨</span>飞沙走石</button>
            <button id="力拔山兮白手" title="掀翻棋盘，棋盘上当前的棋子随机掉落。"><span class="icon">🏔️</span>力拔山兮</button>
            <button id="静如止水白手" title="冻结时间，使对手失去一回合落子机会。"><span class="icon">❄️</span>静如止水</button>
            <button id="调呈离山白手" title="强制将对手棋子移动到棋盘边缘的冷宫区，该区域棋子无法参与连珠。"><span class="icon">↪️</span>调呈离山</button>
            <button id="时光倒流白手" title="将棋局重置回3步之前的状态，双方棋子位置恢复。"><span class="icon">⏪</span>时光倒流</button>
            <button id="拾金不昧白手" title="随机与对手交换一枚棋子，包括已连成线的棋子。"><span class="icon">🔄</span>拾金不昧</button>
        </div>
        <button id="restart">重新开始</button>
    </div>
    <!-- 中央棋盘区域 -->
    <div id="board-container">
        <div id="board"></div>
    </div>
    <!-- 技能描述文字版 -->
    <h3>技能描述</h3>
    <div id="skillDescriptions">
        <p><strong>飞沙走石：</strong>移除对手任意一枚棋子，并封锁该落点使其下一回合无法落子。</p>
        <p><strong>力拔山兮：</strong>掀翻棋盘，棋盘上当前的棋子随机掉落一半。</p>
        <p><strong>静如止水：</strong>冻结时间，使对手失去一回合落子机会。</p>
        <p><strong>调呈离山：</strong>强制将对手棋子移动到棋盘边缘的冷宫区，该棋子无法参与连珠。</p>
        <p><strong>时光倒流：</strong>将棋局重置回 3 步之前的状态，双方棋子位置恢复。</p>
        <p><strong>拾金不昧：</strong>随机与对手交换一枚棋子，包括已连成线的棋子。</p>
    </div>

    <!-- 底部信息，包括版本号、制作者和公众号二维码 -->
    <div id="footer">
        <p>版本：V 5.2</p>
        <p>创作者：ChadBai</p>
        <p>公众号：小少的AI链路笔记</p>
        <img src="qrcode.png" alt="公众号二维码">
    </div>
    <script>
        const boardSize = 11;
        let board = [];
        let currentPlayer = 1;
        let moves = [];
        let skillActive = {1: null, 2: null};
        let skillUsed = {
            1: {'飞沙走石': false, '力拔山兮': false, '静如止水': false, '调呈离山': false, '时光倒流': false, '拾金不昧': false},
            2: {'飞沙走石': false, '力拔山兮': false, '静如止水': false, '调呈离山': false, '时光倒流': false, '拾金不昧': false}
        };
        let blockedPositions = {}; // position key -> player id blocked
        let skipNextTurn = {1: false, 2: false};
        let coldPalacePositions = {}; // key -> true for cold palace
        const playerNames = {1: '黑手', 2: '白手'};
        const skillDescriptions = {
            '飞沙走石': '移除对手任意一枚棋子，并封锁该落点使其下一回合无法落子。',
            '力拔山兮': '掀翻棋盘，棋盘上当前的棋子随机掉落一半。',
            '静如止水': '冻结时间，使对手失去一回合落子机会。',
            '调呈离山': '强制将对手棋子移动到棋盘边缘的冷宫区，该区域棋子无法参与连珠。',
            '时光倒流': '将棋局重置回3步之前的状态，双方棋子位置恢复。',
            '拾金不昧': '随机与对手交换一枚棋子，包括已连成线的棋子。'
        };
        const nextStep = {
            '飞沙走石': '请选择要移除的对手棋子。',
            '力拔山兮': '请点击棋盘任意位置发动技能，棋子将随机掉落。',
            '静如止水': '请点击棋盘任意位置发动技能，冻结对手的下一回合。',
            '调呈离山': '请选择要移动到冷宫区的对手棋子。',
            '时光倒流': '请点击棋盘任意位置回退到3步之前。',
            '拾金不昧': '请点击棋盘任意位置随机交换一枚棋子。'
        };

        function initBoard() {
            board = [];
            for (let r = 0; r < boardSize; r++) {
                const row = [];
                for (let c = 0; c < boardSize; c++) {
                    row.push(0);
                }
                board.push(row);
            }
        }

        function restartGame() {
            initBoard();
            moves = [];
            blockedPositions = {};
            skipNextTurn = {1: false, 2: false};
            coldPalacePositions = {};
            currentPlayer = 1;
            skillActive = {1: null, 2: null};
            skillUsed = {
                1: {'飞沙走石': false, '力拔山兮': false, '静如止水': false, '调呈离山': false, '时光倒流': false, '拾金不昧': false},
                2: {'飞沙走石': false, '力拔山兮': false, '静如止水': false, '调呈离山': false, '时光倒流': false, '拾金不昧': false}
            };
            renderBoard();
            updateSkillButtons();
            document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
        }

        function renderBoard() {
            const container = document.getElementById('board');
            container.style.gridTemplateColumns = `repeat(${boardSize}, 32px)`;
            container.innerHTML = '';
            for (let r = 0; r < boardSize; r++) {
                for (let c = 0; c < boardSize; c++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    const key = `${r},${c}`;
                    if (coldPalacePositions[key]) {
                        cell.classList.add('cold-palace');
                    }
                    if (board[r][c] === 1) {
                        cell.textContent = '●';
                    } else if (board[r][c] === 2) {
                        cell.textContent = '○';
                    }
                    cell.addEventListener('click', () => handleClick(r, c));
                    container.appendChild(cell);
                }
            }
        }

        function disableBoard() {
            const oldBoard = document.getElementById('board');
            const newBoard = oldBoard.cloneNode(true);
            oldBoard.parentNode.replaceChild(newBoard, oldBoard);
        }

        function disableAllSkills() {
            const skillNames = ['飞沙走石','力拔山兮','静如止水','调呈离山','时光倒流','拾金不昧'];
            for (const name of skillNames) {
                document.getElementById(name + '黑手').disabled = true;
                document.getElementById(name + '白手').disabled = true;
            }
        }

        function setSkill(player, skill) {
            if (skillUsed[player][skill]) return;
            skillActive[player] = skill;
            updateSkillButtons();
            document.getElementById('status').textContent = playerNames[player] + '选择了技能 ' + skill + '：' + skillDescriptions[skill] + ' ' + nextStep[skill];
        }

        function updateSkillButtons() {
            const skills = ['飞沙走石','力拔山兮','静如止水','调呈离山','时光倒流','拾金不昧'];
            // 黑手
            for (const name of skills) {
                const btn1 = document.getElementById(name + '黑手');
                // 禁用条件：技能已用过、已有技能待执行，或当前不是黑手回合
                btn1.disabled = skillUsed[1][name] || (skillActive[1] !== null) || (currentPlayer !== 1);
            }
            // 白手
            for (const name of skills) {
                const btn2 = document.getElementById(name + '白手');
                // 禁用条件：技能已用过、已有技能待执行，或当前不是白手回合
                btn2.disabled = skillUsed[2][name] || (skillActive[2] !== null) || (currentPlayer !== 2);
            }
        }

        function handleClick(row, col) {
            // Skip next turn if applicable
            if (skipNextTurn[currentPlayer]) {
                skipNextTurn[currentPlayer] = false;
                currentPlayer = currentPlayer === 1 ? 2 : 1;
                // 更新技能按钮以反映新回合
                updateSkillButtons();
                document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
                return;
            }
            // Remove blocked positions for current player at start of their turn
            for (const key in blockedPositions) {
                if (blockedPositions[key] === currentPlayer) {
                    delete blockedPositions[key];
                }
            }
            const skill = skillActive[currentPlayer];
            const opponent = currentPlayer === 1 ? 2 : 1;
            // Handle skill usage if active
            if (skill) {
                if (skill === '飞沙走石') {
                    // Only allow removing opponent's stone
                    if (board[row][col] === opponent) {
                        blockedPositions[`${row},${col}`] = opponent;
                        board[row][col] = 0;
                        delete coldPalacePositions[`${row},${col}`];
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['飞沙走石'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    // 更新技能按钮以反映回合切换
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
                    return;
                } else if (skill === '力拔山兮') {
                    // Randomly remove pieces from the board (50% chance)
                    for (let r = 0; r < boardSize; r++) {
                        for (let c = 0; c < boardSize; c++) {
                            if (board[r][c] !== 0) {
                                if (Math.random() < 0.5) {
                                    board[r][c] = 0;
                                    delete coldPalacePositions[`${r},${c}`];
                                }
                            }
                        }
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['力拔山兮'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
                    return;
                } else if (skill === '静如止水') {
                    // Freeze opponent: skip their next turn
                    skipNextTurn[opponent] = true;
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['静如止水'] = true;
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
                    return;
                } else if (skill === '调呈离山') {
                    // Move opponent's stone to edge cold palace
                    if (board[row][col] === opponent) {
                        const edges = [];
                        for (let r = 0; r < boardSize; r++) {
                            for (let c = 0; c < boardSize; c++) {
                                if (r === 0 || c === 0 || r === boardSize - 1 || c === boardSize - 1) {
                                    if (board[r][c] === 0) {
                                        edges.push({r: r, c: c});
                                    }
                                }
                            }
                        }
                        if (edges.length > 0) {
                            const idx = Math.floor(Math.random() * edges.length);
                            const newPos = edges[idx];
                            board[row][col] = 0;
                            delete coldPalacePositions[`${row},${col}`];
                            board[newPos.r][newPos.c] = opponent;
                            coldPalacePositions[`${newPos.r},${newPos.c}`] = true;
                        }
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['调呈离山'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
                    return;
                } else if (skill === '时光倒流') {
                    const skillUser = currentPlayer;
                    let removed = 0;
                    while (moves.length > 0 && removed < 3) {
                        const lastMove = moves.pop();
                        board[lastMove.row][lastMove.col] = 0;
                        delete coldPalacePositions[`${lastMove.row},${lastMove.col}`];
                        removed++;
                    }
                    if (moves.length === 0) {
                        currentPlayer = 1;
                    } else {
                        const lastMove = moves[moves.length - 1];
                        currentPlayer = lastMove.player === 1 ? 2 : 1;
                    }
                    skillActive[skillUser] = null;
                    skillUsed[skillUser]['时光倒流'] = true;
                    updateSkillButtons();
                    renderBoard();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
                    return;
                } else if (skill === '拾金不昧') {
                    const currentPieces = [];
                    const opponentPieces = [];
                    for (let r = 0; r < boardSize; r++) {
                        for (let c = 0; c < boardSize; c++) {
                            if (board[r][c] === currentPlayer) currentPieces.push({r: r, c: c});
                            else if (board[r][c] === opponent) opponentPieces.push({r: r, c: c});
                        }
                    }
                    if (currentPieces.length > 0 && opponentPieces.length > 0) {
                        const cp = currentPieces[Math.floor(Math.random() * currentPieces.length)];
                        const op = opponentPieces[Math.floor(Math.random() * opponentPieces.length)];
                        const cpCold = coldPalacePositions[`${cp.r},${cp.c}`] ? true : false;
                        const opCold = coldPalacePositions[`${op.r},${op.c}`] ? true : false;
                        board[cp.r][cp.c] = opponent;
                        board[op.r][op.c] = currentPlayer;
                        delete coldPalacePositions[`${cp.r},${cp.c}`];
                        delete coldPalacePositions[`${op.r},${op.c}`];
                        if (cpCold) {
                            coldPalacePositions[`${op.r},${op.c}`] = true;
                        }
                        if (opCold) {
                            coldPalacePositions[`${cp.r},${cp.c}`] = true;
                        }
                    }
                    skillActive[currentPlayer] = null;
                    skillUsed[currentPlayer]['拾金不昧'] = true;
                    renderBoard();
                    currentPlayer = opponent;
                    updateSkillButtons();
                    document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
                    return;
                }
            }
            // No skill active: place a piece
            const key = `${row},${col}`;
            if (board[row][col] !== 0) return;
            if (blockedPositions[key] === currentPlayer) return;
            board[row][col] = currentPlayer;
            moves.push({row: row, col: col, player: currentPlayer});
            renderBoard();
            if (checkWin(currentPlayer, row, col)) {
                document.getElementById('status').textContent = playerNames[currentPlayer] + '胜利！';
                disableBoard();
                disableAllSkills();
                return;
            }
            currentPlayer = opponent;
            updateSkillButtons();
            document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
        }

        function checkWin(player, row, col) {
            function count(dirRow, dirCol) {
                let count = 0;
                let r = row + dirRow;
                let c = col + dirCol;
                while (r >= 0 && r < boardSize && c >= 0 && c < boardSize && board[r][c] === player && !coldPalacePositions[`${r},${c}`]) {
                    count++;
                    r += dirRow;
                    c += dirCol;
                }
                return count;
            }
            const directions = [[0,1],[1,0],[1,1],[1,-1]];
            for (const [dr, dc] of directions) {
                let total = 1 + count(dr, dc) + count(-dr, -dc);
                if (total >= 5) return true;
            }
            return false;
        }

        function init() {
            initBoard();
            renderBoard();
            document.getElementById('status').textContent = playerNames[currentPlayer] + '落子';
            const skills = ['飞沙走石','力拔山兮','静如止水','调呈离山','时光倒流','拾金不昧'];
            for (const name of skills) {
                document.getElementById(name + '黑手').addEventListener('click', () => setSkill(1, name));
                document.getElementById(name + '白手').addEventListener('click', () => setSkill(2, name));
            }
            document.getElementById('restart').addEventListener('click', restartGame);
            updateSkillButtons();
            // 不再生成技能定义的 JSON 文本，技能描述已在页面上以文字展示
        }
        window.onload = init;
    </script>
</body>
</html>
